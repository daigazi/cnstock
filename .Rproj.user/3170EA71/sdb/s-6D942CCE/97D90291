{
    "contents" : "source(\"cnstock.R\")\n#加载沪深两市股票数据\ncnstock$methods(\n        loadStockName=function(){\n                # load stock name from web\n                library(rvest)\n                library(RCurl)\n                library(XML)\n                url=\"http://bbs.10jqka.com.cn/codelist.html\"\n                web=read_html(url,encoding = \"GBK\")\n                stockName=web  %>% html_nodes(\".bbsilst_wei3 a\") %>% html_text() \n                stockName=stockName[-1]\n                stockName=iconv(x = stockName,from = \"utf-8\",to = \"GBK\")\n                if(save){\n                        if(file.exists(path)){\n                                dir_path=paste(path,\"/stockName.csv\",sep=\"\")      \n                                write.csv(x=stockName,file=dir_path)   \n                        }\n                        else{\n                                \n                                dir.create(path = path,recursive = T)\n                                dir_path=paste(path,\"/stockName.csv\",sep=\"\")\n                                write.csv(x=stockName,file=dir_path) \n                        }  \n                }\n                else{\n                        return(stockName)\n                }\n                Sys.sleep(sleepSec)\n        }\n)\ncnstock$trace(loadStockName,browser) #用来调试loadStockName的\nstock60000$loadStockName()\n#下载网易网页csv数据\ncnstock$methods(\n        loadCsvData=function(Csvname=\"主要财务指标\",type=\"mfi\"){\n                library(rvest)\n                library(RCurl)\n                library(XML)\n                #baseUrl=paste(baseUrl,stockNo,sep=\"\")\n                alltype=as.vector(urldf[,1])\n                #print(type %in% alltype)\n                if(type %in% alltype){\n                        baseUrl=urldf[urldf$name==type,][1,2]\n                        appendUrl=urldf[urldf$name==type,][1,3]  \n                }else{\n                        stop(\"type is wrong\") \n                }\n                url=paste(baseUrl,stockNo,appendUrl,sep=\"\")\n                if(url.exists(url)){\n                        tmp=getBinaryURL(url = url,RCurlheader=RCurlheader)\n                }else{\n                        stop(\"网页不存在\")\n                }\n                #tmp=getBinaryURL(url = url)\n                dir_path=paste(path,\"/\",stockNo,sep=\"\")\n                if(file.exists(dir_path)){\n                        note=file(paste(dir_path,\"/\",Csvname,\".csv\",sep=\"\"),open = \"wb\")\n                        writeBin(tmp, note)\n                        close(note)\n                }\n                else{\n                        dir.create(path = dir_path,recursive = T) \n                        note=file(paste(dir_path,\"/\",Csvname,\".csv\",sep=\"\"),open = \"wb\")\n                        writeBin(tmp, note)\n                        close(note) \n                }\n                Sys.sleep(sleepSec)\n        }\n)\nstock60000=cnstock$new()\nstock60000$loadCsvData(Csvname=\"主要财务指标\",type=\"mfi\")\nstock60000$loadCsvData(\"偿还能力\",\"pay\")\nstock60000$loadCsvData(\"盈利能力\",\"prof\")\nstock60000$loadCsvData(\"成长能力\",\"grow\")\nstock60000$loadCsvData(\"资产负债表\",\"balance\")\nstock60000$loadCsvData(\"利润表\",\"income\")\nstock60000$loadCsvData(\"现金流量表\",\"cash\")\nstock60000$loadCsvData(\"产品比例表\",\"product\")\nstock60000$loadCsvData(\"行业比例表\",\"industry\")\nstock60000$loadCsvData(\"地域比例表\",\"region\")\n\ncnstock$methods(\n        stockBrand=function(){\n                sh=\"600\"\n                if(grepl(stockNo,pattern=sh)){\n                      brand=\"sh\" \n                }else{\n                        brand=\"sz\"\n                }\n                return(brand)\n        }\n        )\nstock60000=cnstock$new()\ncnstock$trace( stockBrand,browser )\nstock60000$stockBrand()\n#股票实时价格\ncnstock$methods(\n        realTimePrice=function(){\n                library(RCurl)\n                url=\"http://hq.sinajs.cn/list=\"\n                brand=stockBrand()\n                url=paste(url,brand,stockNo,sep=\"\")\n                web=getURL(url,.encoding = \"GBK\",httpheader=RCurlheader)\n                word=strsplit(web,split=\",\")\n                tmp=word[[1]]\n                ind=gregexpr(tmp[1],pattern=\"[0-9]\")[[1]][1]\n                stockCode=substr(tmp[1],start=ind,stop=ind+5)\n                stockCompany=substr(tmp[1],start=ind+8,stop=length(tmp[1]))\n                word=c(stockCode,stockCompany,tmp[c(2:length(tmp))])\n#                 0：”大秦铁路”，股票名字；\n#                 1：”27.55″，今日开盘价；\n#                 2：”27.25″，昨日收盘价；\n#                 3：”26.91″，当前价格；\n#                 4：”27.55″，今日最高价；\n#                 5：”26.20″，今日最低价；\n#                 6：”26.91″，竞买价，即“买一”报价；\n#                 7：”26.92″，竞卖价，即“卖一”报价；\n#                 8：”22114263″，成交的股票数，由于股票交易以一百股为基本单位，所以在使用时，通常把该值除以一百；\n#                 9：”589824680″，成交金额，单位为“元”，为了一目了然，通常以“万元”为成交金额的单位，所以通常把该值除以一万；\n#                 10：”4695″，“买一”申请4695股，即47手；\n#                 11：”26.91″，“买一”报价；\n#                 12：”57590″，“买二”\n#                 13：”26.90″，“买二”\n#                 14：”14700″，“买三”\n#                 15：”26.89″，“买三”\n#                 16：”14300″，“买四”\n#                 17：”26.88″，“买四”\n#                 18：”15100″，“买五”\n#                 19：”26.87″，“买五”\n#                 20：”3100″，“卖一”申报3100股，即31手；\n#                 21：”26.92″，“卖一”报价\n#                 (22, 23), (24, 25), (26,27), (28, 29)分别为“卖二”至“卖四的情况”\n#                 30：”2008-01-11″，日期；\n#                 31：”15:05:32″，时间；\n                var<-c( \"股票代码\",\"公司名称\",\n                        \"今日开盘价\",\"昨日收盘价\",\"当前价格\",\"今日最高价\",\"今日最低价\",\n                       \"竞买价\",\"竞卖价\",\"成交的股票数\",\"成交金额\",\"买一股数\",\"买一\",\n                       \"买二股数\",\"买二\",\"买三股数\",\"买三\",\"买四股数\",\"买四\",\"买五股数\",\"买五\",\n                       \"卖一股数\",\"卖一\",\"卖二股数\",\"卖二\",\"卖三股数\",\"卖三\",\"卖四股数\",\n                       \"卖四\",\"卖五股数\",\"日期\",\"时间\")\n                df=data.frame(var=var,value=word)\n                return(df)\n                Sys.sleep(sleepSec)\n        }\n)\nstock60000=cnstock$new()\ncnstock$trace( realTimePrice,browser )\ncnstock$untrace( realTimePrice,browser )\nstock60000$realTimePrice()\n\n#公司简介\ncnstock$methods(\n        ComIntro=function(){\n                library(rvest)\n                library(RCurl)\n                library(XML)\n                #baseUrl=paste(baseUrl,stockNo,sep=\"\")\n                alltype=as.vector(urldf[,1])\n                type=\"intro\"\n                if(type %in% alltype){\n                        baseUrl=urldf[urldf$name==type,][1,2]\n                        appendUrl=urldf[urldf$name==type,][1,3]  \n                }else{\n                        stop(\"type is wrong\") \n                }\n                web=paste(baseUrl,stockNo,appendUrl,sep=\"\")\n                webpage=getURL(url = web,.encoding = \"utf-8\",httpheader=RCurlheader)\n                data=readHTMLTable(doc = webpage,header = T,colClasses = \"character\", trim=T, stringsAsFactors = FALSE)\n                #公司基本信息\n                ComIntro=data[[4]]\n                colnames(ComIntro)=c(\"value\",\"name\",\"value\",\"name\")\n                ComIntro=rbind(ComIntro[,c(1,2)],ComIntro[,c(3,4)])\n                ComIntro=ComIntro[complete.cases(ComIntro),]\n                return(ComIntro)\n                Sys.sleep(sleepSec)\n        }\n)\nstock60000=cnstock$new()\ndf=stock60000$ComIntro()\n#图片下载\ncnstock$methods(\n        loadPic=function(name=\"历史市净率\",type=\"pb\",days=2000,ktype=\"daily\"){\n                library(RCurl)\n                png_pe=c(\"PE\",\"Pe\",\"pe\")\n                png_pb=c(\"PB\",\"Pb\",\"pb\")\n                png_k=c(\"K\",\"k\")\n                if(type %in% png_pe){\n                        baseUrl=urldf[urldf$name==\"pe\",][1,2]\n                        appendUrl=urldf[urldf$name==\"pe\",][1,3]\n                        url=paste(baseUrl,stockNo,appendUrl,days,sep=\"\")\n                }else if(type %in% png_pb){\n                        baseUrl=urldf[urldf$name==\"pb\",][1,2]\n                        appendUrl=urldf[urldf$name==\"pb\",][1,3]\n                        url=paste(baseUrl,stockNo,appendUrl,days,sep=\"\")\n                }else if(type  %in% png_k){\n                        baseUrl=urldf[urldf$name==\"k\",][1,2]\n                        appendUrl=urldf[urldf$name==\"k\",][1,3]\n                        #http://image.sinajs.cn/newchart/min/n/sh000001.gif\n                        stockBrandNo=stockBrand()\n                        url=paste(baseUrl,ktype,appendUrl,stockBrandNo,\"gif\",sep=\"\")\n                }\n                else{\n                    stop(\"type should be pe or pb\")    \n                }       \n                Pic=getBinaryURL(url = url,httpheader=RCurlheader)\n                dir_path=paste(path,\"/\",stockNo,sep=\"\")\n                if(file.exists(dir_path)){\n                        note=file(paste(dir_path,\"/\",name,\".png\",sep=\"\"),open = \"wb\")\n                        writeBin(Pic, note)\n                        close(note)\n                }\n                else{\n                        dir.create(path = dir_path,recursive = T) \n                        note=file(paste(dir_path,\"/\",name,\".png\",sep=\"\"),open = \"wb\")\n                        writeBin(Pic, note)\n                        close(note) \n                }\n        }        \n)\nstock60000=cnstock$new()\nstock60000$loadPic(days=5000)\nstock60000$loadPic(name=\"历史市盈率\",type=\"pe\",days=2000)\nstock60000$loadPic(name=\"历史市净率\",type=\"pb\",days=2000)\nstock60000$loadPic(name=\"月k线\",type=\"k\",ktype=\"monthly\")\n",
    "created" : 1449967741703.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "3|33|29|8|\n35|58|68|8|\n83|30|91|8|\n153|28|176|8|\n182|73|218|8|\n",
    "hash" : "2405672218",
    "id" : "97D90291",
    "lastKnownWriteTime" : 1449974910,
    "path" : "D:/LearnGit/cnstock/methods.R",
    "project_path" : "methods.R",
    "properties" : {
    },
    "relative_order" : 0,
    "source_on_save" : false,
    "type" : "r_source"
}